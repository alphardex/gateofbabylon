title: 平凡粒子造就特效最强
author: alphardex
abbrlink: 64108
date: 2021-09-04 20:30:53
tags:

---

## 前言

大家好，这里是 CSS 兼 WebGL 魔法使——alphardex。

让我们开始吧！

<!--more-->

## 准备工作

笔者的 [p5.js 模板](https://codepen.io/alphardex/pen/rNwOZYz)，点击右下角可以 fork 一份

## 创作开始

### 粒子类

```ts
class Particle {
  s: p5;
  position: p5.Vector; // 位置
  constructor(s: p5, position = s.createVector(0, 0)) {
    this.s = s;
    this.position = position.copy();
  }
  // 显示
  display() {
    this.s.circle(this.position.x, this.position.y, 6);
  }
  // 运行
  run() {
    this.display();
  }
}
```

### 粒子系统类

```ts
class ParticleSystem {
  s: p5;
  particles: Particle[]; // 该系统下的所有微粒
  origin: p5.Vector; // 系统原点
  constructor(s: p5, origin = s.createVector(0, 0)) {
    this.s = s;
    this.particles = [];
    this.origin = origin;
  }
  // 添加单个微粒
  addParticle() {
    const particle = new Particle(this.s, this.origin);
    this.particles.push(particle);
  }
  // 添加多个微粒
  addParticles(count = 1) {
    for (let i = 0; i < count; i++) {
      this.addParticle();
    }
  }
  // 运行
  run() {
    for (const particle of this.particles) {
      particle.run();
    }
  }
}
```

### 创建粒子

```ts
const sketch = (s: p5) => {
  let ps: ParticleSystem;

  const setup = () => {
    s.createCanvas(s.windowWidth, s.windowHeight);

    ps = new ParticleSystem(s, s.createVector(s.width / 2, s.height / 2));

    ps.addParticles(100);
  };

  const draw = () => {
    s.background(0);
    s.blendMode(s.ADD);

    ps.run();

    s.blendMode(s.BLEND);
  };

  s.setup = setup;
  s.draw = draw;
};
```

[![hfRxqe.png](https://z3.ax1x.com/2021/09/06/hfRxqe.png)](https://imgtu.com/i/hfRxqe)

100 个粒子重叠在了画面中央

### 打乱粒子位置

```ts
class ParticleSystem {
  ...
  // 打乱微粒位置
  shuffle() {
    this.particles.forEach((p) => {
      const x = this.s.random(0, this.s.width);
      const y = this.s.random(0, this.s.height);
      const randPos = this.s.createVector(x, y);
      p.position = randPos;
    });
  }
}

const sketch = (s: p5) => {
  ...

  const setup = () => {
    ...
    ps.shuffle();
  };
};
```

[![hfWQGq.png](https://z3.ax1x.com/2021/09/06/hfWQGq.png)](https://imgtu.com/i/hfWQGq)

100 个粒子分散在了画面各处

### 粒子漫游

```ts
class Particle {
  ...
  velocity: p5.Vector; // 速度
  constructor(s: p5, position = s.createVector(0, 0)) {
    ...
    this.velocity = this.s.createVector(0, 0);
  }
  // 更新状态
  update() {
    this.position.add(this.velocity);
  }
  // 运行
  run() {
    this.update();
    this.display();
  }
}

class ParticleSystem {
  ...
  // 让微粒随机漫游
  wander() {
    this.particles.forEach((p) => {
      const x = this.s.random(-1, 1);
      const y = this.s.random(-1, 1);
      const randVel = this.s.createVector(x, y);
      p.velocity = randVel;
    });
  }
}

const sketch = (s: p5) => {
  ...

  const setup = () => {
    ...
    ps.wander();
  };
};
```

### 对粒子施加力

```ts
class Particle {
  ...
  acceleration: p5.Vector; // 加速度
  constructor(s: p5, position = s.createVector(0, 0)) {
    ...
    this.acceleration = this.s.createVector(0, 0);
  }
  // 更新状态
  update() {
    this.velocity.add(this.acceleration);
    this.position.add(this.velocity);
    this.acceleration.mult(0);
  }
  // 施加力
  applyForce(force: p5.Vector) {
    // 牛顿第二定律: F = ma
    const mass = 1; // 这里设质量为单位1
    const acceleration = p5.Vector.div(force, mass);
    this.acceleration.add(acceleration);
  }
}

class ParticleSystem {
  ...
  // 对每个微粒施加力
  applyForce(force: p5.Vector) {
    this.particles.forEach((p) => p.applyForce(force));
  }
}

const sketch = (s: p5) => {
  ...
  const draw = () => {
    ...

    ps.run();

    const gravity = s.createVector(0, 0.05);
    ps.applyForce(gravity);

    ...
  };
};
```

[![hfhjMV.gif](https://z3.ax1x.com/2021/09/06/hfhjMV.gif)](https://imgtu.com/i/hfhjMV)

### 吸引体类

```ts
class Attractor {
  s: p5;
  position: p5.Vector; // 位置
  attractForceMag: number; // 吸引力大小
  constructor(s: p5, position = s.createVector(0, 0)) {
    this.s = s;
    this.position = position;
    this.attractForceMag = 0.05;
  }
  // 显示
  display() {
    this.s.circle(this.position.x, this.position.y, 32);
  }
  // 施加引力
  applyAttractForce(p: Particle) {
    const attractForce = p5.Vector.sub(this.position, p.position);
    attractForce.setMag(this.attractForceMag);
    p.applyForce(attractForce);
  }
}

class ParticleSystem {
  ...
  // 对每个微粒应用吸引力
  applyAttractor(attractor: Attractor) {
    this.particles.forEach((p) => attractor.applyAttractForce(p));
  }
}

const sketch = (s: p5) => {
  ...
  let attractor: Attractor;

  const setup = () => {
    ...

    attractor = new Attractor(s, s.createVector(s.width / 2, s.height / 2));
  };

  const draw = () => {
    ...

    // const gravity = s.createVector(0, 0.05);
    // ps.applyForce(gravity);
    attractor.display();
    ps.applyAttractor(attractor);

    ...
  };
};
```

[![hf4jfA.gif](https://z3.ax1x.com/2021/09/06/hf4jfA.gif)](https://imgtu.com/i/hf4jfA)

### 点击添加吸引体

```ts
const sketch = (s: p5) => {
  ...
  // let attractor: Attractor;
  let attractors: Attractor[] = [];
  let mousePos: p5.Vector;

  const setup = () => {
    ...
    // attractor = new Attractor(s, s.createVector(s.width / 2, s.height / 2));
  };

  const draw = () => {
    mousePos = s.createVector(s.mouseX, s.mouseY);

    ...

    // const gravity = s.createVector(0, 0.05);
    // ps.applyForce(gravity);
    // attractor.display();
    // ps.applyAttractor(attractor);
    attractors.forEach((attractor) => {
      attractor.display();
      ps.applyAttractor(attractor);
    });

    ...
  };

  const mousePressed = () => {
    const attractor = new Attractor(s, mousePos);
    attractors.push(attractor);
  };

  ...
  s.mousePressed = mousePressed;
};
```

[![hf573n.gif](https://z3.ax1x.com/2021/09/06/hf573n.gif)](https://imgtu.com/i/hf573n)
